/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/base/util/uid","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/util/ManagedObjectModel"],function(F,u,J){"use strict";var C={};C.applyChange=function(c,o,p){if(p.modifier.targets!=="jsControlTree"){throw new Error("Combine buttons change can't be applied on XML tree");}var a=c.getDefinition();var m=p.modifier;var v=F.getViewForControl(o);var A=p.appComponent;var s=m.bySelector(a.content.combineButtonSelectors[0],A);var P=m.getParent(s);var i;var b;var B;var I=sap.ui.getCore().getConfiguration().getRTL();var M;var d;var e=[];var r={parentAggregation:"",insertIndexes:[]};B=a.content.combineButtonSelectors.map(function(f){return m.bySelector(f,A);});b=B[0].sParentAggregationName;r.parentAggregation=b;i=m.findIndexInParentAggregation(s);M=m.createControl("sap.m.Menu",A,v,a.content.menuIdSelector);B.forEach(function(f,g){var h;var j;var S=a.content.buttonsIdForSave[g];var k=m.getProperty(f,"text");r.insertIndexes[g]=m.findIndexInParentAggregation(f);j=m.createControl("sap.m.MenuItem",A,v,S);m.attachEvent(j,"press","sap.m.changeHandler.CombineButtons.pressHandler",m.getSelector(f,A));var l="$sap.m.flexibility.CombineButtonsModel";var n=m.createControl("sap.ui.fl.util.ManagedObjectModel",A,v,Object.assign({},S,{id:S.id+'-managedObjectModel'}),{object:f,name:l});m.insertAggregation(j,"dependents",n);m.bindProperty(j,"text",l+">/text");m.bindProperty(j,"icon",l+">/icon");m.bindProperty(j,"enabled",l+">/enabled");m.bindProperty(j,"visible",l+">/visible");m.bindAggregation(j,"customData",{path:l+">/customData",template:m.createControl("sap.ui.core.CustomData",A,v,Object.assign({},S,{id:S.id+'-customData'}),{key:{path:l+">key"},value:{path:l+">value"}})});if(k){I?e.unshift(k):e.push(k);}S.id=S.id+"-originalButtonId";h=m.createControl("sap.ui.core.CustomData",A,v,S);m.setProperty(h,"key","originalButtonId");m.setProperty(h,"value",m.getId(f));m.removeAggregation(P,b,f);m.insertAggregation(P,"dependents",f);m.insertAggregation(j,"customData",h,0);m.insertAggregation(M,"items",j,g);});d=m.createControl("sap.m.MenuButton",A,v,a.content.menuButtonIdSelector);m.setProperty(d,"text",e.join("/"));m.insertAggregation(d,"menu",M,0);m.insertAggregation(P,b,d,i);c.setRevertData(r);return true;};C.revertChange=function(c,o,p){var m=p.modifier;var v=F.getViewForControl(o);var r=c.getRevertData();var a=c.getDefinition();var P=r.parentAggregation;var M=m.bySelector(a.content.menuButtonIdSelector,p.appComponent,v);var b=m.getParent(M);var B=a.content.combineButtonSelectors;var d;for(var i=0;i<B.length;i++){d=m.bySelector(B[i],p.appComponent);m.insertAggregation(b,P,d,r.insertIndexes[i]);}m.removeAggregation(b,P,M);m.destroy(M);var s=r.insertIndexes.map(function(e,i){return{ind:i,val:e};});s.sort(function(x,y){return x.val-y.val;});for(var i=0;i<B.length;i++){var I=s[i].ind;var f=s[i].val;d=m.bySelector(B[I],p.appComponent);m.insertAggregation(b,P,d,f);}c.resetRevertData();return true;};C.completeChangeContent=function(c,s,p){var m=p.modifier;var a=p.appComponent;var o=c.getDefinition();var b=s.combineElementIds;if(b&&b.length>1){c.addDependentControl(b,"combinedButtons",p);o.content.combineButtonSelectors=b.map(function(d){return m.getSelector(d,a);});o.content.menuButtonIdSelector=m.getSelector(a.createId(u()),a);o.content.menuIdSelector=m.getSelector(a.createId(u()),a);o.content.buttonsIdForSave=b.map(function(){return m.getSelector(a.createId(u()),a);});}else{throw new Error("Combine buttons action cannot be completed: oSpecificChangeInfo.combineElementIds attribute required");}};C.pressHandler=function(e,s){var b=J.bySelector(s);b.firePress();};return C;},true);
