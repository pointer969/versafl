/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/Manifest","sap/base/Log"],function(B,M,L){"use strict";var a="/sap.card/configuration/parameters";var C=B.extend("sap.ui.integration.util.CardManifest",{constructor:function(m){B.call(this);if(m){this._oManifest=new M(m,{process:false});this.oJson=this._oManifest.getRawJson();}}});C.prototype.getJson=function(){return this._unfreeze(this.oJson);};C.prototype.get=function(P){return this._unfreeze(g(this.oJson,P));};C.prototype._unfreeze=function(v){if(typeof v==="object"){return JSON.parse(JSON.stringify(v));}return v;};C.prototype.destroy=function(){this.oJson=null;this.oTranslator=null;if(this._oManifest){this._oManifest.destroy();}};C.prototype.load=function(s){if(!s||!s.manifestUrl){throw new Error("manifestUrl is mandatory!");}return M.load({manifestUrl:s.manifestUrl,async:true}).then(function(m){this._oManifest=m;this.oJson=this._oManifest.getRawJson();return this.loadI18n().then(function(){this.processManifest();}.bind(this));}.bind(this));};C.prototype.loadI18n=function(){return this._oManifest._loadI18n(true).then(function(o){this.oTranslator=o;}.bind(this));};C.prototype.processManifest=function(P){var i=0,m=15,u=jQuery.extend(true,{},this._oManifest.getRawJson());e(u,this.oTranslator,i,m,P);d(u);this.oJson=u;};function d(o){if(o&&typeof o==='object'&&!Object.isFrozen(o)){Object.freeze(o);for(var k in o){if(o.hasOwnProperty(k)){d(o[k]);}}}}function b(v){return(typeof v==="string")&&v.indexOf("{{")===0&&v.indexOf("}}")===v.length-2;}function c(v){return(typeof v==="string")&&(v.indexOf("{{parameters.")>-1);}function p(P,o){var i=new Date().toISOString();var s=P.replace("{{parameters.NOW_ISO}}",i);s=s.replace("{{parameters.TODAY_ISO}}",i.slice(0,10));if(o){for(var f in o){s=s.replace("{{parameters."+f+"}}",o[f].value);}}return s;}function e(o,t,i,m,P){if(i===m){return;}if(Array.isArray(o)){o.forEach(function(I,f,A){if(typeof I==="object"){e(I,t,i+1,m,P);}else if(c(I,o,P)){A[f]=p(I,P);}else if(b(I)&&t){A[f]=t.getText(I.substring(2,I.length-2));}},this);}else{for(var s in o){if(typeof o[s]==="object"){e(o[s],t,i+1,m,P);}else if(c(o[s],o,P)){o[s]=p(o[s],P);}else if(b(o[s])&&t){o[s]=t.getText(o[s].substring(2,o[s].length-2));}}}}function g(o,P){if(o&&P&&typeof P==="string"&&P[0]==="/"){var f=P.substring(1).split("/"),s;for(var i=0,l=f.length;i<l;i++){s=f[i];o=o.hasOwnProperty(s)?o[s]:undefined;if(o===null||typeof o!=="object"){if(i+1<l&&o!==undefined){o=undefined;}break;}}return o;}return o&&o[P];}C.prototype.processParameters=function(P){var m=this.get(a);if(P&&!m){L.error("If parameters property is set, parameters should be described in the manifest");}if(m){var o=this._syncParameters(P,m);this.processManifest(o);}};C.prototype._syncParameters=function(P,m){if(!P){return m;}var o=jQuery.extend(true,{},m),f=Object.getOwnPropertyNames(P),h=Object.getOwnPropertyNames(o);for(var i=0;i<h.length;i++){for(var j=0;j<f.length;j++){if(h[i]===f[j]){o[h[i]].value=P[f[j]];}}}return o;};return C;},true);
