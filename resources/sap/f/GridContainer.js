/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/base/ManagedObjectObserver",'sap/ui/core/ResizeHandler',"sap/ui/core/delegate/ItemNavigation","sap/f/GridContainerRenderer","sap/ui/Device","sap/ui/layout/cssgrid/VirtualGrid","sap/f/GridContainerSettings","sap/ui/dom/units/Rem","sap/base/Log"],function(C,M,R,I,G,D,V,a,b,L){"use strict";var E=16;function g(i){var l=i.getLayoutData();return l?l.getColumns():1;}function c(i){var l=i.getLayoutData();return l?l.getActualRows():1;}function h(i){var l=i.getLayoutData();return l?l.hasAutoHeight():true;}function d($){var i=0;$.children().each(function(){i+=jQuery(this).height();});return i;}function e(){return!D.browser.msie&&!(D.browser.edge&&D.browser.version<E);}var f=C.extend("sap.f.GridContainer",{metadata:{library:"sap.f",properties:{width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:""},snapToRow:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.core.Control",multiple:true,singularName:"item",dnd:true},layout:{type:"sap.f.GridContainerSettings",multiple:false},layoutS:{type:"sap.f.GridContainerSettings",multiple:false},layoutM:{type:"sap.f.GridContainerSettings",multiple:false},layoutL:{type:"sap.f.GridContainerSettings",multiple:false},layoutXL:{type:"sap.f.GridContainerSettings",multiple:false},_defaultLayout:{type:"sap.f.GridContainerSettings",multiple:false,visibility:"hidden"}},dnd:{draggable:false,droppable:true}}});f.prototype._onBeforeItemRendering=function(){var i=this.getParent(),r=i._resizeListeners[this.getId()];if(r){R.deregister(r);}delete i._resizeListeners[this.getId()];};f.prototype._onAfterItemRendering=function(){var i=this.getParent();if(!e()){i._applyIEPolyfillForItem(this);}i._resizeListeners[this.getId()]=R.register(this.getDomRef(),i._resizeHandler);i._setItemNavigationItems();i._applyLayout();};f.prototype._onItemChange=function(i){if(i.name!=="items"||!i.child){return;}if(i.mutation==="insert"){i.child.addEventDelegate(this._itemDelegate,i.child);}else if(i.mutation==="remove"){i.child.removeEventDelegate(this._itemDelegate,i.child);}};f.prototype._deregisterResizeListeners=function(){var k,i;for(k in this._resizeListeners){i=this._resizeListeners[k];R.deregister(i);}delete this._resizeListeners;};f.prototype._setItemNavigationItems=function(){if(!this._isRenderingFinished){return;}};f.prototype._detectActiveLayout=function(){var w=window.innerWidth,r=D.media.getCurrentRange("StdExt",w),l=f.mSizeLayouts[r.name];if(this._sActiveLayout===l){return;}this._sActiveLayout=l;};f.prototype.getActiveLayoutSettings=function(){return this.getAggregation(this._sActiveLayout)||this.getAggregation("layout")||this.getAggregation("_defaultLayout");};f.prototype.init=function(){this.setAggregation("_defaultLayout",new a());this._detectActiveLayout();this._resizeListeners={};this._itemDelegate={onBeforeRendering:this._onBeforeItemRendering,onAfterRendering:this._onAfterItemRendering};this._itemsObserver=new M(this._onItemChange.bind(this));this._itemsObserver.observe(this,{aggregations:["items"]});this._resizeHandler=this._resize.bind(this);this._itemNavigation=new I().setCycling(false);this._itemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"]});this.addDelegate(this._itemNavigation);};f.prototype.onBeforeRendering=function(){var r=this._resizeListeners[this.getId()];if(r){R.deregister(r);}this._isRenderingFinished=false;};f.prototype.onAfterRendering=function(){this._resizeListeners[this.getId()]=R.register(this.getDomRef(),this._resizeHandler);this._isRenderingFinished=true;this._setItemNavigationItems();this._applyLayout();};f.prototype.exit=function(){this._deregisterResizeListeners();if(this._itemsObserver){this._itemsObserver.disconnect();delete this._itemsObserver;}if(this._itemNavigation){this.removeDelegate(this._itemNavigation);this._itemNavigation.destroy();delete this._itemNavigation;}};f.prototype._resize=function(){var o=this.getActiveLayoutSettings();this._detectActiveLayout();if(o!==this.getActiveLayoutSettings()){this.invalidate();return;}this._applyLayout();};f.prototype._applyLayout=function(){if(!this._isRenderingFinished){return;}if(e()){var o=this;this.getItems().forEach(function(i){if(h(i)){var $=i.$(),k=$.height(),l=o.$(),r=parseInt(l.css("grid-auto-rows")),m=parseInt(l.css("grid-row-gap")),n=Math.ceil((k+m)/(r+m));$.parent().css({'grid-row':'span '+Math.max(n,c(i))});}});}else{this._applyIEPolyfillLayout();}};function j(s){if(s===0||s==="0"){return 0;}var m=s.match(/^(\d+(\.\d+)?)(px|rem)$/);if(m){if(m[3]==="px"){return parseFloat(m[1]);}else{return b.toPx(parseFloat(m[1]));}}else{L.error("Css size '"+s+"' is not supported for GridContainer. Only 'px' and 'rem' are supported.");}}f.prototype._applyIEPolyfillForItem=function(i){var s=this.getActiveLayoutSettings(),k=j(s.getColumnSize()),l=j(s.getRowSize()),m=j(s.getGap()),n=g(i),w=n*k+(n-1)*m,o={top:0,left:0,width:w,position:'absolute'};if(!h(i)){var p=c(i);o.height=p*l+(p-1)*m;}i.$().parent().css(o);};f.prototype._applyIEPolyfillLayout=function(){var $=this.$(),w=$.innerWidth(),s=this.getActiveLayoutSettings(),k=j(s.getColumnSize()),l=j(s.getRowSize()),m=j(s.getGap()),n=s.getColumns()||Math.floor((w+m)/(k+m)),t=parseInt($.css("padding-top").replace("px","")),o=parseInt($.css("padding-left").replace("px","")),p=this.getItems(),q=this.$().children();if(!p.length){return;}var v=new V();v.init({numberOfCols:Math.max(1,n),cellWidth:k,cellHeight:l,unitOfMeasure:"px",gapSize:m,topOffset:t?t:0,leftOffset:o?o:0});var i,r,u,x,y,z,A,B,F=[];for(i=0;i<p.length;i++){r=p[i];x=g(r);y=jQuery(q.get(i));if(h(r)){z=y.find('.sapFCard');if(z.length){B=z.height();}else{B=d(y);}A=Math.ceil((B+m)/(l+m));}else{A=c(r);}F[i]=A;v.fitElement(i+'',x,A);}v.calculatePositions();for(i=0;i<p.length;i++){r=p[i];u=v.getItems()[i];y=jQuery(q.get(i));A=F[i];y.css({position:'absolute',top:u.top,left:u.left,height:A*l+(A-1)*m});}$.css("height",v.getHeight()+"px");};f.mSizeLayouts={"Phone":"layoutS","Tablet":"layoutM","Desktop":"layoutL","LargeDesktop":"layoutXL"};return f;});
